theory ODoH_Fix begin

// Function signature and definition of the equational theory E

builtins: diffie-hellman
functions: Expand/3, Extract/2, aead/4, aead_verify/4, decrypt/3,
           fst/1, h/1, hmac/1, pair/2, pk/1, sdec/2, senc/2, sign/2, snd/1,
           true/0, verify/3
equations:
    aead_verify(k, n, a, aead(k, n, a, p)) = true,
    decrypt(k, n, aead(k, n, a, p)) = p,
    fst(<x.1, x.2>) = x.1,
    sdec(senc(x.1, x.2), x.2) = x.1,
    snd(<x.1, x.2>) = x.2,
    verify(sign(x.1, x.2), x.1, pk(x.2)) = true



restriction Eq_check_succeed:
  "∀ x y #i. (Eq( x, y ) @ #i) ⇒ (x = y)"
  // safety formula

restriction Neq_check_succeed:
  "∀ x y #i. (Neq( x, y ) @ #i) ⇒ (¬(x = y))"
  // safety formula

rule (modulo E) Starter:
   [ Fr( ~kxy ) ]
  --[ Channel( $X, $Y ) ]->
   [
   KeyExC( $X, $Y, ~kxy ), KeyExS( $X, $Y, ~kxy ),
   KeyExI( $X, $Y, ~kxy )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_DH_key_pair:
   [ Fr( ~x ), Fr( ~key_id ) ]
  -->
   [
   !Pk( $A, ~key_id, 'g'^~x ), Out( <~key_id, 'g'^~x> ),
   !Ltk( $A, ~key_id, ~x )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_QueryGeneration:
   [
   KeyExC( $C, $P, ~k ), !Pk( $T, ~key_id, gy ), Fr( ~x ),
   Fr( ~msg_id ), Fr( ~connection_id ), Fr( ~q )
   ]
  --[
  Neq( $P, $T ),
  CQE_sources( ~msg_id, 'g'^~x,
               aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                    Expand(Extract(Expand(Extract('blank',
                                                  <'HPKE_v1', 'eae_prk', gy^~x>),
                                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                   <'HPKE_v1', 'secret', 'blank'>),
                           <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                            Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                           '32'),
                    <'0x01', '32', ~key_id>, ~q)
  ),
  CQE( $C, $P, $T, ~connection_id, ~q, ~msg_id, 'g'^~x, gy, ~k )
  ]->
   [
   Out( senc(<~connection_id, $T, ~msg_id, '0x01', ~key_id, 'g'^~x, 
              aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                          <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                   Expand(Extract(Expand(Extract('blank',
                                                 <'HPKE_v1', 'eae_prk', gy^~x>),
                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                  <'HPKE_v1', 'secret', 'blank'>),
                          <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                           Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                          '32'),
                   <'0x01', '32', ~key_id>, ~q)
             >,
             ~k)
   ),
   C_ResponseHandler( ~q, $C, 'g'^~x, $P, ~k, $T, gy,
                      Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gy^~x>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                      ~msg_id
   )
   ]

  /*
  rule (modulo AC) C_QueryGeneration:
     [
     KeyExC( $C, $P, ~k ), !Pk( $T, ~key_id, gy ), Fr( ~x ),
     Fr( ~msg_id ), Fr( ~connection_id ), Fr( ~q )
     ]
    --[
    Neq( $P, $T ),
    CQE_sources( ~msg_id, 'g'^~x,
                 aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                      Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                     <'HPKE_v1', 'secret', 'blank'>),
                             <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                              Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                             '32'),
                      <'0x01', '32', ~key_id>, ~q)
    ),
    CQE( $C, $P, $T, ~connection_id, ~q, ~msg_id, 'g'^~x, gy, ~k )
    ]->
     [
     Out( senc(<~connection_id, $T, ~msg_id, '0x01', ~key_id, 'g'^~x, 
                aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                     Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                                    <'HPKE_v1', 'secret', 'blank'>),
                            <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                             Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                            '32'),
                     <'0x01', '32', ~key_id>, ~q)
               >,
               ~k)
     ),
     C_ResponseHandler( ~q, $C, 'g'^~x, $P, ~k, $T, gy,
                        Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, gy>, '32'),
                        ~msg_id
     )
     ]
    variants (modulo AC)
    1. ~x    = ~x.19
       gy    = gy.20
       z     = gy.20^~x.19
    
    2. ~x    = ~x.25
       gy    = z.32^inv(~x.25)
       z     = z.32
    
    3. ~x    = ~x.220
       gy    = x.429^x.430
       z     = x.429^(~x.220*x.430)
    
    4. ~x    = ~x.221
       gy    = x.431^inv((~x.221*x.432))
       z     = x.431^inv(x.432)
    
    5. ~x    = ~x.221
       gy    = x.431^(x.432*inv(~x.221))
       z     = x.431^x.432
    
    6. ~x    = ~x.222
       gy    = x.432^(x.433*inv((~x.222*x.434)))
       z     = x.432^(x.433*inv(x.434))
  */

rule (modulo E) P_HandleQuery:
   [
   KeyExS( $C, $P, ~k ),
   In( senc(<~connection_id, $T, msg_id, msg_type, key_id, gx, 
             opaque_message>,
            ~k)
   ),
   Fr( ~ptid ), In( key_id )
   ]
  --[ PHQ( msg_id, gx, opaque_message ), Eq( msg_type, '0x01' ) ]->
   [
   Out( <$T, msg_id, msg_type, key_id, gx, opaque_message> ),
   P_ResponseHandler( ~ptid, $C, $P, ~k, msg_id )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) T_HandleQuery:
   [
   In( <$T, msg_id, msg_type, ~key_id, gx, 
        aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                    <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
             Expand(Extract(Expand(Extract('blank',
                                           <'HPKE_v1', 'eae_prk', gx^~y>),
                                   <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                            <'HPKE_v1', 'secret', 'blank'>),
                    <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                     Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                    '32'),
             <'0x01', '32', ~key_id>, query)
       >
   ),
   !Ltk( $T, ~key_id, ~y ), Fr( ~ttid ), Fr( ~r ), Fr( ~key_id2 )
   ]
  --[
  Eq( msg_type, '0x01' ),
  Eq( aead_verify(Expand(Extract('blank',
                                 <'HPKE_v1', 'eae_prk', gx^~y>),
                         <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                  Expand(Extract(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', gx^~y>),
                                        <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                 <'HPKE_v1', 'secret', 'blank'>),
                         <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                          Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                         '32'),
                  <'0x01', '32', ~key_id>,
                  aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', gx^~y>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', gx^~y>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                              '32'),
                       <'0x01', '32', ~key_id>, query)),
      true
  ),
  T_Done( ~ttid, msg_id ), T_Answer( $T, gx, 'g'^~y, query, ~r )
  ]->
   [
   Out( <msg_id, '0x02', ~key_id2, 
         aead(Expand(Extract(<query, ~key_id2>,
                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                  <'HPKE_v1', 'eae_prk', gx^~y>),
                                                          <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                           'g'^~y>,
                                                          '32'),
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                            Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                           >,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                     'odoh_key', '32'),
              Expand(Extract(<query, ~key_id2>,
                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                  <'HPKE_v1', 'eae_prk', gx^~y>),
                                                          <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                           'g'^~y>,
                                                          '32'),
                                                   <'HPKE_v1', 'secret', 'blank'>),
                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                            Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                           >,
                                           '32'),
                                    <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                     'odoh_nonce', '32'),
              <'0x02', ~key_id2>, ~r)
        >
   )
   ]

  /*
  rule (modulo AC) T_HandleQuery:
     [
     In( <$T, msg_id, msg_type, ~key_id, gx, 
          aead(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                      <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
               Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                     <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                              <'HPKE_v1', 'secret', 'blank'>),
                      <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                       Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                      '32'),
               <'0x01', '32', ~key_id>, query)
         >
     ),
     !Ltk( $T, ~key_id, ~y ), Fr( ~ttid ), Fr( ~r ), Fr( ~key_id2 )
     ]
    --[
    Eq( msg_type, '0x01' ), Eq( true, true ), T_Done( ~ttid, msg_id ),
    T_Answer( $T, gx, 'g'^~y, query, ~r )
    ]->
     [
     Out( <msg_id, '0x02', ~key_id2, 
           aead(Expand(Extract(<query, ~key_id2>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z>),
                                                            <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                             'g'^~y>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x01', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                       'odoh_key', '32'),
                Expand(Extract(<query, ~key_id2>,
                               Expand(Expand(Extract(Expand(Extract('blank',
                                                                    <'HPKE_v1', 'eae_prk', z>),
                                                            <'32', 'HPKE_v1', 'shared_secret', gx, 
                                                             'g'^~y>,
                                                            '32'),
                                                     <'HPKE_v1', 'secret', 'blank'>),
                                             <'32', 'HPKE_v1', 'exp', '0x01', 
                                              Extract('blank',
                                                      <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                             >,
                                             '32'),
                                      <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                       'odoh_nonce', '32'),
                <'0x02', ~key_id2>, ~r)
          >
     )
     ]
    variants (modulo AC)
    1. ~y    = ~y.17
       gx    = gx.18
       z     = gx.18^~y.17
    
    2. ~y    = ~y.24
       gx    = z.32^inv(~y.24)
       z     = z.32
    
    3. ~y    = ~y.523
       gx    = x.1038^x.1039
       z     = x.1038^(~y.523*x.1039)
    
    4. ~y    = ~y.524
       gx    = x.1040^inv((~y.524*x.1041))
       z     = x.1040^inv(x.1041)
    
    5. ~y    = ~y.524
       gx    = x.1040^(x.1041*inv(~y.524))
       z     = x.1040^x.1041
    
    6. ~y    = ~y.525
       gx    = x.1041^(x.1042*inv((~y.525*x.1043)))
       z     = x.1041^(x.1042*inv(x.1043))
  */

rule (modulo E) P_HandleResponse:
   [
   P_ResponseHandler( ~ptid, $C, $P, ~k, msg_id ),
   In( <msg_id, msg_type, key_id, opaque_message> )
   ]
  --[ P_Done( ~ptid, msg_id ), Eq( msg_type, '0x02' ) ]->
   [ Out( senc(<msg_id, msg_type, key_id, opaque_message>, ~k) ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) C_HandleResponse:
   [
   C_ResponseHandler( ~query, $C, gx, $P, ~k, $T, gy, shared_secret,
                      ~msg_id
   ),
   In( senc(<~msg_id, msg_type, key_id, 
             aead(Expand(Extract(<~query, key_id>,
                                 Expand(Expand(Extract(shared_secret,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                        <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                         'odoh_key', '32'),
                  Expand(Extract(<~query, key_id>,
                                 Expand(Expand(Extract(shared_secret,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                        <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                         'odoh_nonce', '32'),
                  <'0x02', key_id>, answer)
            >,
            ~k)
   )
   ]
  --[
  Eq( msg_type, '0x02' ),
  Eq( aead_verify(Expand(Extract(<~query, key_id>,
                                 Expand(Expand(Extract(shared_secret,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                        <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                         'odoh_key', '32'),
                  Expand(Extract(<~query, key_id>,
                                 Expand(Expand(Extract(shared_secret,
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                        <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                         'odoh_nonce', '32'),
                  <'0x02', key_id>,
                  aead(Expand(Extract(<~query, key_id>,
                                      Expand(Expand(Extract(shared_secret,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                              'odoh_key', '32'),
                       Expand(Extract(<~query, key_id>,
                                      Expand(Expand(Extract(shared_secret,
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                              'odoh_nonce', '32'),
                       <'0x02', key_id>, answer)),
      true
  ),
  C_Done( ~query, answer, $C, gx, $T, gy )
  ]->
   [ ]

  /*
  rule (modulo AC) C_HandleResponse:
     [
     C_ResponseHandler( ~query, $C, gx, $P, ~k, $T, gy, shared_secret,
                        ~msg_id
     ),
     In( senc(<~msg_id, msg_type, key_id, 
               aead(Expand(Extract(<~query, key_id>,
                                   Expand(Expand(Extract(shared_secret,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                          <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                           'odoh_key', '32'),
                    Expand(Extract(<~query, key_id>,
                                   Expand(Expand(Extract(shared_secret,
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                          <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                           'odoh_nonce', '32'),
                    <'0x02', key_id>, answer)
              >,
              ~k)
     )
     ]
    --[
    Eq( msg_type, '0x02' ), Eq( true, true ),
    C_Done( ~query, answer, $C, gx, $T, gy )
    ]->
     [ ]
  */

rule (modulo E) RevSK:
   [ KeyExI( $X, $Y, ~kxy ) ] --[ RevSk( ~kxy ) ]-> [ Out( ~kxy ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) RevDH:
   [ !Ltk( $A, ~key_id, ~x ) ]
  --[ RevDH( $A, ~key_id, 'g'^~x ) ]->
   [ Out( ~x ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) NonceReuse:
   [ In( aead(k, n, a1, p1) ), In( aead(k, n, a2, p2) ) ]
  --[ Neq( p1, p2 ), ReuseNonce( k, n, p1, p2 ) ]->
   [ Out( p1 ) ]

  /* has exactly the trivial AC variant */

lemma PHQ_source [sources]:
  all-traces
  "∀ mid gx op #j.
    (PHQ( mid, gx, op ) @ #j) ⇒
    ((∃ #i. (CQE_sources( mid, gx, op ) @ #i) ∧ (#i < #j)) ∨
     (((∃ #i. (!KU( mid ) @ #i) ∧ (#i < #j)) ∧
       (∃ #i. (!KU( gx ) @ #i) ∧ (#i < #j))) ∧
      (∃ #i. (!KU( op ) @ #i) ∧ (#i < #j))))"
/*
guarded formula characterizing all counter-examples:
"∃ mid gx op #j.
  (PHQ( mid, gx, op ) @ #j)
 ∧
  (∀ #i. (CQE_sources( mid, gx, op ) @ #i) ⇒ ¬(#i < #j)) ∧
  (((∀ #i. (!KU( mid ) @ #i) ⇒ ¬(#i < #j)) ∨
    (∀ #i. (!KU( gx ) @ #i) ⇒ ¬(#i < #j)) ∨
    (∀ #i. (!KU( op ) @ #i) ⇒ ¬(#i < #j))))"
*/
by sorry

lemma aead_source [sources]:
  all-traces
  "∀ k n a p #j.
    (!KU( aead(k, n, a, p) ) @ #j) ⇒
    (((∃ #i. (!KU( p ) @ #i) ∧ (#i < #j)) ∨
      (∃ T gx gy q #i. (T_Answer( T, gx, gy, q, p ) @ #i) ∧ (#i < #j))) ∨
     (∃ C P T cid msg_id gx gy key #i.
       (CQE( C, P, T, cid, p, msg_id, gx, gy, key ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ k n a p #j.
  (!KU( aead(k, n, a, p) ) @ #j)
 ∧
  (∀ #i. (!KU( p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ T gx gy q #i. (T_Answer( T, gx, gy, q, p ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ C P T cid msg_id gx gy key #i.
    (CQE( C, P, T, cid, p, msg_id, gx, gy, key ) @ #i) ⇒ ¬(#i < #j))"
*/
by sorry

lemma end_to_end:
  exists-trace
  "∃ q a C gx T gy #i. C_Done( q, a, C, gx, T, gy ) @ #i"
/*
guarded formula characterizing all satisfying traces:
"∃ q a C gx T gy #i. (C_Done( q, a, C, gx, T, gy ) @ #i)"
*/
simplify
solve( C_ResponseHandler( ~query, $C, gx, $P, ~k, $T, gy,
                          shared_secret, ~msg_id
       ) ▶₀ #i )
  case C_QueryGeneration
  solve( !KU( senc(<~msg_id, '0x02', key_id, 
                    aead(Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_key', '32'),
                         Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_nonce', '32'),
                         <'0x02', key_id>, a)
                   >,
                   ~k)
         ) @ #vk )
    case P_HandleResponse
    solve( !KU( aead(Expand(Extract(<~query, key_id>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                            'odoh_key', '32'),
                     Expand(Extract(<~query, key_id>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                            'odoh_nonce', '32'),
                     <'0x02', key_id>, a)
           ) @ #vk.7 )
      case T_HandleQuery
      solve( !KU( senc(<~connection_id.1, $T.1, ~msg_id, '0x01', 
                        key_id.1, gx, opaque_message>,
                       ~k)
             ) @ #vk.8 )
        case C_QueryGeneration
        solve( !KU( ~msg_id ) @ #vk.5 )
          case C_QueryGeneration
          by sorry
        next
          case P_HandleQuery
          solve( !KU( senc(<~connection_id.1, $T.1, ~msg_id, '0x01', 
                            key_id.1, 'g'^~x, 
                            aead(Expand(Extract('blank',
                                                <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                        <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32'),
                                 Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                        'g'^~x.1>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                         Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                        '32'),
                                 <'0x01', '32', ~key_id>, ~query)
                           >,
                           ~k.1)
                 ) @ #vk.20 )
            case C_QueryGeneration
            solve( !KU( ~key_id ) @ #vk.9 )
              case C_QueryGeneration
              by sorry
            next
              case Generate_DH_key_pair
              solve( !KU( ~key_id2 ) @ #vk.9 )
                case T_HandleQuery
                solve( !KU( 'g'^~x ) @ #vk.18 )
                  case P_HandleQuery
                  solve( !KU( senc(<~connection_id.1, $T.1, ~msg_id, '0x01', 
                                    key_id.1, 'g'^~x, 
                                    aead(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                >,
                                                '32'),
                                         Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~x.1)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~x.1>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                                 Extract('blank',
                                                         <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                                >,
                                                '32'),
                                         <'0x01', '32', ~key_id>, ~query)
                                   >,
                                   ~k.1)
                         ) @ #vk.20 )
                    case C_QueryGeneration
                    solve( !KU( aead(Expand(Extract('blank',
                                                    <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                            <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                            '32'),
                                     Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                             Extract('blank',
                                                     <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                            >,
                                            '32'),
                                     <'0x01', '32', ~key_id>, ~query)
                           ) @ #vk.19 )
                      case P_HandleQuery
                      SOLVED // trace found
                    qed
                  qed
                next
                  case c_exp
                  by sorry
                qed
              qed
            qed
          next
            case P_HandleResponse
            by contradiction /* cyclic */
          next
            case c_senc
            by contradiction /* cyclic */
          qed
        qed
      next
        case c_senc
        by sorry
      qed
    next
      case c_aead
      by sorry
    qed
  next
    case c_senc
    by sorry
  qed
qed

lemma secret_query:
  all-traces
  "∀ C P T cid q msg_id gx gy key #j #k.
    ((CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
     (!KU( q ) @ #k)) ⇒
    (∃ kid #i. (RevDH( T, kid, gy ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C P T cid q msg_id gx gy key #j #k.
  (CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
  (!KU( q ) @ #k)
 ∧
  ∀ kid #i. (RevDH( T, kid, gy ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
  case Starter
  solve( !Pk( $T, ~key_id, gy ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~q ) @ #k.1 )
      case C_QueryGeneration
      solve( !KU( ~k ) @ #vk.6 )
        case RevSK
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.26 )
          case C_QueryGeneration
          solve( !KU( ~x ) @ #vk.33 )
            case RevDH
            by contradiction /* from formulas */
          qed
        next
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.33 )
        next
          case c_exp
          solve( !KU( ~x ) @ #vk.35 )
            case RevDH
            by contradiction /* from formulas */
          qed
        qed
      qed
    next
      case NonceReuse
      solve( !KU( aead(k.2, n, a1, ~q) ) @ #vk )
        case C_QueryGeneration
        solve( !KU( ~k ) @ #vk.2 )
          case RevSK
          solve( !KU( aead(Expand(Extract('blank',
                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                           Expand(Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>),
                                  <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                   Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                  '32'),
                           a2, p2)
                 ) @ #vk.2 )
            case C_QueryGeneration
            by contradiction /* from formulas */
          next
            case c_aead
            solve( !KU( Expand(Extract('blank',
                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                   ) @ #vk.3 )
              case c_Expand
              solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x
                                                >,
                                                '32'),
                                         <'HPKE_v1', 'secret', 'blank'>),
                                 <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                  Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                 '32')
                     ) @ #vk.4 )
                case c_Expand
                solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                       ) @ #vk.7 )
                  case c_Extract
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.20 )
                    case c_Extract
                    solve( !KU( 'g'^(~x*~x.1) ) @ #vk.31 )
                      case C_QueryGeneration
                      solve( !KU( ~x ) @ #vk.33 )
                        case RevDH
                        by contradiction /* from formulas */
                      qed
                    next
                      case Generate_DH_key_pair
                      by solve( !KU( ~x.1 ) @ #vk.33 )
                    next
                      case c_exp
                      solve( !KU( ~x ) @ #vk.35 )
                        case RevDH
                        by contradiction /* from formulas */
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( aead(Expand(Extract('blank',
                                        <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                         Expand(Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                 Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                '32'),
                         a2, p2)
               ) @ #vk.1 )
          case P_HandleQuery
          by contradiction /* from formulas */
        next
          case c_aead
          solve( !KU( Expand(Extract('blank',
                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                 ) @ #vk.4 )
            case c_Expand
            solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                      <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                              <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                              '32'),
                                       <'HPKE_v1', 'secret', 'blank'>),
                               <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                               '32')
                   ) @ #vk.5 )
              case c_Expand
              solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                     ) @ #vk.8 )
                case c_Extract
                solve( !KU( Extract(Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                           '32'),
                                    <'HPKE_v1', 'secret', 'blank'>)
                       ) @ #vk.21 )
                  case c_Extract
                  solve( !KU( 'g'^(~x*~x.1) ) @ #vk.32 )
                    case Generate_DH_key_pair
                    by solve( !KU( ~x.1 ) @ #vk.34 )
                  next
                    case P_HandleQuery
                    solve( !KU( ~x ) @ #vk.34 )
                      case RevDH
                      by contradiction /* from formulas */
                    qed
                  next
                    case c_exp
                    solve( !KU( ~x ) @ #vk.36 )
                      case RevDH
                      by contradiction /* from formulas */
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case c_aead
        by contradiction /* cyclic */
      qed
    next
      case P_HandleQuery
      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.26 )
        case Generate_DH_key_pair
        by solve( !KU( ~x.1 ) @ #vk.34 )
      next
        case P_HandleQuery
        solve( !KU( ~x ) @ #vk.34 )
          case RevDH
          by contradiction /* from formulas */
        qed
      next
        case c_exp
        solve( !KU( ~x ) @ #vk.36 )
          case RevDH
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
qed

lemma secret_response:
  all-traces
  "∀ T gx gy q a #j #k.
    ((T_Answer( T, gx, gy, q, a ) @ #j) ∧ (!KU( a ) @ #k)) ⇒
    ((∃ kid #i. (RevDH( T, kid, gy ) @ #i) ∧ (#i < #k)) ∨
     (∃ #i. (!KU( q ) @ #i) ∧ (#i < #k)))"
/*
guarded formula characterizing all counter-examples:
"∃ T gx gy q a #j #k.
  (T_Answer( T, gx, gy, q, a ) @ #j) ∧ (!KU( a ) @ #k)
 ∧
  (∀ kid #i. (RevDH( T, kid, gy ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ #i. (!KU( q ) @ #i) ⇒ ¬(#i < #k))"
*/
simplify
solve( !Ltk( $T, ~key_id, ~y ) ▶₁ #j )
  case Generate_DH_key_pair
  solve( !KU( ~key_id ) @ #vk.7 )
    case C_QueryGeneration
    solve( !KU( ~r ) @ #k.1 )
      case NonceReuse
      solve( !KU( ~k ) @ #vk.12 )
        case RevSK
        solve( !KU( aead(Expand(Extract('blank',
                                        <'HPKE_v1', 'eae_prk', z>),
                                <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                         Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                               <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>),
                                <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                 Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                '32'),
                         <'0x01', '32', ~key_id>, q)
               ) @ #vk.12 )
          case C_QueryGeneration
          solve( !KU( ~k.3 ) @ #vk.14 )
            case RevSK
            solve( !KU( aead(k.3, n, a1, ~r) ) @ #vk.4 )
              case T_HandleQuery
              solve( !KU( aead(Expand(Extract(<~q, ~key_id2>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'odoh_query'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>,
                                                     '32')),
                                      'odoh_key', '32'),
                               Expand(Extract(<~q, ~key_id2>,
                                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                                   <'HPKE_v1', 
                                                                                    'eae_prk', 
                                                                                    'g'^(~x*~y)>),
                                                                           <'32', 'HPKE_v1', 
                                                                            'shared_secret', 
                                                                            'g'^~x, 'g'^~y>,
                                                                           '32'),
                                                                    <'HPKE_v1', 'secret', 'blank'>),
                                                            <'32', 'HPKE_v1', 'exp', '0x01', 
                                                             Extract('blank',
                                                                     <'HPKE_v1', 'info_hash', 
                                                                      'odoh_query'>)
                                                            >,
                                                            '32'),
                                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>,
                                                     '32')),
                                      'odoh_nonce', '32'),
                               a2, p2)
                     ) @ #vk.14 )
                case T_HandleQuery
                by contradiction /* from formulas */
              next
                case c_aead
                solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'odoh_query'>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                   'odoh_key', '32')
                       ) @ #vk.15 )
                  case c_Expand
                  solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                             Expand(Expand(Extract(Expand(Extract('blank',
                                                                                  <'HPKE_v1', 
                                                                                   'eae_prk', 
                                                                                   'g'^(~x*~y)>),
                                                                          <'32', 'HPKE_v1', 
                                                                           'shared_secret', 'g'^~x, 
                                                                           'g'^~y>,
                                                                          '32'),
                                                                   <'HPKE_v1', 'secret', 'blank'>),
                                                           <'32', 'HPKE_v1', 'exp', '0x01', 
                                                            Extract('blank',
                                                                    <'HPKE_v1', 'info_hash', 
                                                                     'odoh_query'>)
                                                           >,
                                                           '32'),
                                                    <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                     'odoh_nonce', '32')
                         ) @ #vk.16 )
                    case c_Expand
                    solve( !KU( Extract(<~q, ~key_id2>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~y)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~y>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', 
                                                       Extract('blank',
                                                               <'HPKE_v1', 'info_hash', 'odoh_query'
                                                               >)
                                                      >,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                           ) @ #vk.19 )
                      case c_Extract
                      by contradiction /* from formulas */
                    qed
                  qed
                qed
              qed
            next
              case c_aead
              by contradiction /* cyclic */
            qed
          qed
        next
          case P_HandleQuery
          solve( !KU( aead(k.2, n, a1, ~r) ) @ #vk.3 )
            case T_HandleQuery
            solve( !KU( aead(Expand(Extract(<~q, ~key_id2>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'odoh_query'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                    'odoh_key', '32'),
                             Expand(Extract(<~q, ~key_id2>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'odoh_query'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                    'odoh_nonce', '32'),
                             a2, p2)
                   ) @ #vk.13 )
              case T_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'),
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 
                                                                 'odoh_query'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                 'odoh_key', '32')
                     ) @ #vk.16 )
                case c_Expand
                solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'odoh_query'>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                   'odoh_nonce', '32')
                       ) @ #vk.17 )
                  case c_Expand
                  solve( !KU( Extract(<~q, ~key_id2>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~y)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 'g'^~y
                                                                   >,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                         ) @ #vk.20 )
                    case c_Extract
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        next
          case c_aead
          by contradiction /* from formulas */
        qed
      qed
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  next
    case Generate_DH_key_pair
    solve( !KU( ~r ) @ #k )
      case NonceReuse
      solve( !KU( aead(Expand(Extract('blank',
                                      <'HPKE_v1', 'eae_prk', z>),
                              <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                       Expand(Extract(Expand(Extract('blank', <'HPKE_v1', 'eae_prk', z>),
                                             <'32', 'HPKE_v1', 'shared_secret', gx, 'g'^~y>, '32'),
                                      <'HPKE_v1', 'secret', 'blank'>),
                              <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                               Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                              '32'),
                       <'0x01', '32', ~key_id>, q)
             ) @ #vk.11 )
        case C_QueryGeneration
        solve( !KU( ~k.2 ) @ #vk.13 )
          case RevSK
          solve( !KU( aead(k.2, n, a1, ~r) ) @ #vk.3 )
            case T_HandleQuery
            solve( !KU( aead(Expand(Extract(<~q, ~key_id2>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'odoh_query'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                    'odoh_key', '32'),
                             Expand(Extract(<~q, ~key_id2>,
                                            Expand(Expand(Extract(Expand(Extract('blank',
                                                                                 <'HPKE_v1', 
                                                                                  'eae_prk', 
                                                                                  'g'^(~x*~y)>),
                                                                         <'32', 'HPKE_v1', 
                                                                          'shared_secret', 'g'^~x, 
                                                                          'g'^~y>,
                                                                         '32'),
                                                                  <'HPKE_v1', 'secret', 'blank'>),
                                                          <'32', 'HPKE_v1', 'exp', '0x01', 
                                                           Extract('blank',
                                                                   <'HPKE_v1', 'info_hash', 
                                                                    'odoh_query'>)
                                                          >,
                                                          '32'),
                                                   <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                    'odoh_nonce', '32'),
                             a2, p2)
                   ) @ #vk.13 )
              case T_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'),
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 
                                                                 'odoh_query'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                 'odoh_key', '32')
                     ) @ #vk.14 )
                case c_Expand
                solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                           Expand(Expand(Extract(Expand(Extract('blank',
                                                                                <'HPKE_v1', 
                                                                                 'eae_prk', 
                                                                                 'g'^(~x*~y)>),
                                                                        <'32', 'HPKE_v1', 
                                                                         'shared_secret', 'g'^~x, 
                                                                         'g'^~y>,
                                                                        '32'),
                                                                 <'HPKE_v1', 'secret', 'blank'>),
                                                         <'32', 'HPKE_v1', 'exp', '0x01', 
                                                          Extract('blank',
                                                                  <'HPKE_v1', 'info_hash', 
                                                                   'odoh_query'>)
                                                         >,
                                                         '32'),
                                                  <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                   'odoh_nonce', '32')
                       ) @ #vk.15 )
                  case c_Expand
                  solve( !KU( Extract(<~q, ~key_id2>,
                                      Expand(Expand(Extract(Expand(Extract('blank',
                                                                           <'HPKE_v1', 'eae_prk', 
                                                                            'g'^(~x*~y)>),
                                                                   <'32', 'HPKE_v1', 
                                                                    'shared_secret', 'g'^~x, 'g'^~y
                                                                   >,
                                                                   '32'),
                                                            <'HPKE_v1', 'secret', 'blank'>),
                                                    <'32', 'HPKE_v1', 'exp', '0x01', 
                                                     Extract('blank',
                                                             <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                                    >,
                                                    '32'),
                                             <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                         ) @ #vk.18 )
                    case c_Extract
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( aead(k.1, n, a1, ~r) ) @ #vk.2 )
          case T_HandleQuery
          solve( !KU( aead(Expand(Extract(<~q, ~key_id2>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x01', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'odoh_query'>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                  'odoh_key', '32'),
                           Expand(Extract(<~q, ~key_id2>,
                                          Expand(Expand(Extract(Expand(Extract('blank',
                                                                               <'HPKE_v1', 
                                                                                'eae_prk', 
                                                                                'g'^(~x*~y)>),
                                                                       <'32', 'HPKE_v1', 
                                                                        'shared_secret', 'g'^~x, 
                                                                        'g'^~y>,
                                                                       '32'),
                                                                <'HPKE_v1', 'secret', 'blank'>),
                                                        <'32', 'HPKE_v1', 'exp', '0x01', 
                                                         Extract('blank',
                                                                 <'HPKE_v1', 'info_hash', 
                                                                  'odoh_query'>)
                                                        >,
                                                        '32'),
                                                 <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                  'odoh_nonce', '32'),
                           a2, p2)
                 ) @ #vk.12 )
            case T_HandleQuery
            by contradiction /* from formulas */
          next
            case c_aead
            solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~y)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 'g'^~y
                                                                    >,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x01', 
                                                      Extract('blank',
                                                              <'HPKE_v1', 'info_hash', 'odoh_query'
                                                              >)
                                                     >,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                               'odoh_key', '32')
                   ) @ #vk.15 )
              case c_Expand
              solve( !KU( Expand(Extract(<~q, ~key_id2>,
                                         Expand(Expand(Extract(Expand(Extract('blank',
                                                                              <'HPKE_v1', 
                                                                               'eae_prk', 
                                                                               'g'^(~x*~y)>),
                                                                      <'32', 'HPKE_v1', 
                                                                       'shared_secret', 'g'^~x, 
                                                                       'g'^~y>,
                                                                      '32'),
                                                               <'HPKE_v1', 'secret', 'blank'>),
                                                       <'32', 'HPKE_v1', 'exp', '0x01', 
                                                        Extract('blank',
                                                                <'HPKE_v1', 'info_hash', 
                                                                 'odoh_query'>)
                                                       >,
                                                       '32'),
                                                <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                 'odoh_nonce', '32')
                     ) @ #vk.16 )
                case c_Expand
                solve( !KU( Extract(<~q, ~key_id2>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~y)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~y>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', 
                                                   Extract('blank',
                                                           <'HPKE_v1', 'info_hash', 'odoh_query'>)
                                                  >,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                       ) @ #vk.19 )
                  case c_Extract
                  by contradiction /* from formulas */
                qed
              qed
            qed
          qed
        next
          case c_aead
          by contradiction /* cyclic */
        qed
      next
        case c_aead
        by contradiction /* from formulas */
      qed
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  qed
qed

lemma secret_response_nr:
  all-traces
  "∀ T q gx gy a #j #k.
    ((T_Answer( T, gx, gy, q, a ) @ #j) ∧ (!KU( a ) @ #k)) ⇒
    (((∃ k.1 n p #i. (ReuseNonce( k.1, n, a, p ) @ #i) ∧ (#i < #k)) ∨
      (∃ kid #i. (RevDH( T, kid, gy ) @ #i) ∧ (#i < #k))) ∨
     (∃ #i. (!KU( q ) @ #i) ∧ (#i < #k)))"
/*
guarded formula characterizing all counter-examples:
"∃ T q gx gy a #j #k.
  (T_Answer( T, gx, gy, q, a ) @ #j) ∧ (!KU( a ) @ #k)
 ∧
  (∀ k.1 n p #i. (ReuseNonce( k.1, n, a, p ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ kid #i. (RevDH( T, kid, gy ) @ #i) ⇒ ¬(#i < #k)) ∧
  (∀ #i. (!KU( q ) @ #i) ⇒ ¬(#i < #k))"
*/
simplify
solve( !Ltk( $T, ~key_id, ~y ) ▶₁ #j )
  case Generate_DH_key_pair
  solve( !KU( ~key_id ) @ #vk.7 )
    case C_QueryGeneration
    solve( !KU( ~r ) @ #k.1 )
      case NonceReuse
      by contradiction /* from formulas */
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  next
    case Generate_DH_key_pair
    solve( !KU( ~r ) @ #k )
      case NonceReuse
      by contradiction /* from formulas */
    next
      case T_HandleQuery
      by contradiction /* from formulas */
    qed
  qed
qed

lemma secret_cid:
  all-traces
  "∀ C P T cid q msg_id gx gy key #j #k.
    ((CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
     (!KU( cid ) @ #k)) ⇒
    (∃ #i. (RevSk( key ) @ #i) ∧ (#i < #k))"
/*
guarded formula characterizing all counter-examples:
"∃ C P T cid q msg_id gx gy key #j #k.
  (CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
  (!KU( cid ) @ #k)
 ∧
  ∀ #i. (RevSk( key ) @ #i) ⇒ ¬(#i < #k)"
*/
simplify
solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
  case Starter
  solve( !Pk( $T, ~key_id, gy ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~connection_id ) @ #k.1 )
      case C_QueryGeneration
      solve( !KU( ~k ) @ #vk )
        case RevSK
        by contradiction /* from formulas */
      qed
    qed
  qed
qed

lemma query_binding:
  all-traces
  "∀ C P T cid q msg_id gx gy key #j #k #l.
    (((CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
      (!KU( q ) @ #k)) ∧
     (!KU( cid ) @ #l)) ⇒
    (∃ kid #h #i.
      (((RevDH( T, kid, gy ) @ #i) ∧ (#i < #k)) ∧ (RevSk( key ) @ #h)) ∧
      (#h < #l))"
/*
guarded formula characterizing all counter-examples:
"∃ C P T cid q msg_id gx gy key #j #k #l.
  (CQE( C, P, T, cid, q, msg_id, gx, gy, key ) @ #j) ∧
  (!KU( q ) @ #k) ∧
  (!KU( cid ) @ #l)
 ∧
  ∀ kid #h #i.
   (RevDH( T, kid, gy ) @ #i) ∧ (RevSk( key ) @ #h)
  ⇒
   ((¬(#i < #k)) ∨ (¬(#h < #l)))"
*/
simplify
solve( KeyExC( $C, $P, ~k ) ▶₀ #j )
  case Starter
  solve( !Pk( $T, ~key_id, gy ) ▶₁ #j )
    case Generate_DH_key_pair
    solve( !KU( ~q ) @ #k.1 )
      case C_QueryGeneration
      solve( !KU( ~k ) @ #vk.6 )
        case RevSK
        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.26 )
          case C_QueryGeneration
          solve( !KU( ~x ) @ #vk.33 )
            case RevDH
            solve( (#vr.10 = #l)  ∥ (#l < #vr.10) )
              case case_1
              by solve( !KU( ~connection_id ) @ #l )
            next
              case case_2
              solve( !KU( ~connection_id ) @ #l )
                case C_QueryGeneration
                by contradiction /* cyclic */
              qed
            qed
          qed
        next
          case Generate_DH_key_pair
          by solve( !KU( ~x.1 ) @ #vk.33 )
        next
          case c_exp
          solve( !KU( ~x ) @ #vk.35 )
            case RevDH
            solve( (#vr.10 = #l)  ∥ (#l < #vr.10) )
              case case_1
              by solve( !KU( ~connection_id ) @ #l )
            next
              case case_2
              solve( !KU( ~connection_id ) @ #l )
                case C_QueryGeneration
                by contradiction /* cyclic */
              qed
            qed
          qed
        qed
      qed
    next
      case NonceReuse
      solve( !KU( ~connection_id ) @ #l )
        case C_QueryGeneration
        solve( !KU( ~k ) @ #vk.2 )
          case RevSK
          solve( !KU( aead(k.2, n, a1, ~q) ) @ #vk.1 )
            case C_QueryGeneration
            solve( !KU( aead(Expand(Extract('blank',
                                            <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                    <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                    'g'^~x>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                     Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                    '32'),
                             a2, p2)
                   ) @ #vk.2 )
              case C_QueryGeneration
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract('blank',
                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                     ) @ #vk.3 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                   'g'^~x>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                    Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                   '32')
                       ) @ #vk.4 )
                  case c_Expand
                  solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                         ) @ #vk.7 )
                    case c_Extract
                    solve( !KU( Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>)
                           ) @ #vk.20 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.31 )
                        case C_QueryGeneration
                        solve( !KU( ~x ) @ #vk.33 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x.1 ) @ #vk.33 )
                      next
                        case c_exp
                        solve( !KU( ~x ) @ #vk.35 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          next
            case P_HandleQuery
            solve( !KU( aead(Expand(Extract('blank',
                                            <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                    <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32'),
                             Expand(Extract(Expand(Extract('blank',
                                                           <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                   <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                    'g'^~x>,
                                                   '32'),
                                            <'HPKE_v1', 'secret', 'blank'>),
                                    <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                     Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                    '32'),
                             a2, p2)
                   ) @ #vk.2 )
              case P_HandleQuery
              by contradiction /* from formulas */
            next
              case c_aead
              solve( !KU( Expand(Extract('blank',
                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>, '32')
                     ) @ #vk.5 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 
                                                   'g'^~x>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'base_nonce', '0x01', 
                                    Extract('blank', <'HPKE_v1', 'info_hash', 'odoh_query'>)>,
                                   '32')
                       ) @ #vk.6 )
                  case c_Expand
                  solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                         ) @ #vk.9 )
                    case c_Extract
                    solve( !KU( Extract(Expand(Extract('blank',
                                                       <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                               <'32', 'HPKE_v1', 'shared_secret', 'g'^~x.1, 'g'^~x>,
                                               '32'),
                                        <'HPKE_v1', 'secret', 'blank'>)
                           ) @ #vk.22 )
                      case c_Extract
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.33 )
                        case Generate_DH_key_pair
                        by solve( !KU( ~x.1 ) @ #vk.35 )
                      next
                        case P_HandleQuery
                        solve( !KU( ~x ) @ #vk.35 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case c_exp
                        solve( !KU( ~x ) @ #vk.37 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            qed
          next
            case c_aead
            by contradiction /* cyclic */
          qed
        qed
      qed
    next
      case P_HandleQuery
      solve( !KU( ~connection_id ) @ #l )
        case C_QueryGeneration
        solve( !KU( ~k ) @ #vk.34 )
          case RevSK
          solve( !KU( 'g'^(~x*~x.1) ) @ #vk.28 )
            case Generate_DH_key_pair
            by solve( !KU( ~x.1 ) @ #vk.35 )
          next
            case P_HandleQuery
            solve( !KU( ~x ) @ #vk.35 )
              case RevDH
              by contradiction /* from formulas */
            qed
          next
            case c_exp
            solve( !KU( ~x ) @ #vk.37 )
              case RevDH
              by contradiction /* from formulas */
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma consistency:
  all-traces
  "∀ q a C gx T gy #j.
    (C_Done( q, a, C, gx, T, gy ) @ #j) ⇒
    ((∃ #i. (T_Answer( T, gx, gy, q, a ) @ #i) ∧ (#i < #j)) ∨
     (∃ kid #i. (RevDH( T, kid, gy ) @ #i) ∧ (#i < #j)))"
/*
guarded formula characterizing all counter-examples:
"∃ q a C gx T gy #j.
  (C_Done( q, a, C, gx, T, gy ) @ #j)
 ∧
  (∀ #i. (T_Answer( T, gx, gy, q, a ) @ #i) ⇒ ¬(#i < #j)) ∧
  (∀ kid #i. (RevDH( T, kid, gy ) @ #i) ⇒ ¬(#i < #j))"
*/
simplify
solve( C_ResponseHandler( ~query, $C, gx, $P, ~k, $T, gy,
                          shared_secret, ~msg_id
       ) ▶₀ #j )
  case C_QueryGeneration
  solve( !KU( senc(<~msg_id, '0x02', key_id, 
                    aead(Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_key', '32'),
                         Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_nonce', '32'),
                         <'0x02', key_id>, a)
                   >,
                   ~k)
         ) @ #vk )
    case P_HandleResponse
    solve( !KU( aead(Expand(Extract(<~query, key_id>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                            'odoh_key', '32'),
                     Expand(Extract(<~query, key_id>,
                                    Expand(Expand(Extract(Expand(Extract('blank',
                                                                         <'HPKE_v1', 'eae_prk', 
                                                                          'g'^(~x*~x.1)>),
                                                                 <'32', 'HPKE_v1', 'shared_secret', 
                                                                  'g'^~x, 'g'^~x.1>,
                                                                 '32'),
                                                          <'HPKE_v1', 'secret', 'blank'>),
                                                  <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                  '32'),
                                           <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                            'odoh_nonce', '32'),
                     <'0x02', key_id>, a)
           ) @ #vk.7 )
      case T_HandleQuery
      by contradiction /* from formulas */
    next
      case c_aead
      solve( !KU( Expand(Extract(<~query, key_id>,
                                 Expand(Expand(Extract(Expand(Extract('blank',
                                                                      <'HPKE_v1', 'eae_prk', 
                                                                       'g'^(~x*~x.1)>),
                                                              <'32', 'HPKE_v1', 'shared_secret', 
                                                               'g'^~x, 'g'^~x.1>,
                                                              '32'),
                                                       <'HPKE_v1', 'secret', 'blank'>),
                                               <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                        <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                         'odoh_key', '32')
             ) @ #vk.11 )
        case c_Expand
        solve( !KU( Expand(Extract(<~query, key_id>,
                                   Expand(Expand(Extract(Expand(Extract('blank',
                                                                        <'HPKE_v1', 'eae_prk', 
                                                                         'g'^(~x*~x.1)>),
                                                                <'32', 'HPKE_v1', 'shared_secret', 
                                                                 'g'^~x, 'g'^~x.1>,
                                                                '32'),
                                                         <'HPKE_v1', 'secret', 'blank'>),
                                                 <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                          <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                           'odoh_nonce', '32')
               ) @ #vk.12 )
          case c_Expand
          solve( !KU( Extract(<~query, key_id>,
                              Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                 ) @ #vk.14 )
            case c_Extract
            solve( !KU( ~query ) @ #vk.20 )
              case C_QueryGeneration
              solve( !KU( ~k ) @ #vk.29 )
                case RevSK
                solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                 <'HPKE_v1', 'eae_prk', 
                                                                  'g'^(~x*~x.1)>),
                                                         <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                          'g'^~x.1>,
                                                         '32'),
                                                  <'HPKE_v1', 'secret', 'blank'>),
                                          <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                   <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                       ) @ #vk.29 )
                  case c_Expand
                  solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                            <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                    <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                     'g'^~x.1>,
                                                    '32'),
                                             <'HPKE_v1', 'secret', 'blank'>),
                                     <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                         ) @ #vk.55 )
                    case c_Expand
                    solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
                      case C_QueryGeneration
                      solve( !KU( ~x.1 ) @ #vk.65 )
                        case RevDH
                        by contradiction /* from formulas */
                      qed
                    next
                      case Generate_DH_key_pair
                      by solve( !KU( ~x ) @ #vk.65 )
                    next
                      case c_exp
                      by solve( !KU( ~x ) @ #vk.67 )
                    qed
                  qed
                qed
              qed
            next
              case NonceReuse
              solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                        'g'^~x.1>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                 <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                     ) @ #vk.21 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                   'g'^~x.1>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                       ) @ #vk.24 )
                  case c_Expand
                  solve( !KU( Extract(Expand(Extract('blank',
                                                     <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                             <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                             '32'),
                                      <'HPKE_v1', 'secret', 'blank'>)
                         ) @ #vk.32 )
                    case c_Extract
                    solve( !KU( Expand(Extract('blank',
                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>, '32')
                           ) @ #vk.39 )
                      case c_Expand
                      solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                             ) @ #vk.45 )
                        case c_Extract
                        solve( !KU( 'g'^(~x*~x.1) ) @ #vk.54 )
                          case C_QueryGeneration
                          solve( !KU( ~k ) @ #vk.55 )
                            case RevSK
                            solve( !KU( ~x.1 ) @ #vk.56 )
                              case RevDH
                              by contradiction /* from formulas */
                            qed
                          qed
                        next
                          case Generate_DH_key_pair
                          by solve( !KU( ~x ) @ #vk.55 )
                        next
                          case P_HandleQuery
                          solve( !KU( ~x.1 ) @ #vk.57 )
                            case RevDH
                            by contradiction /* from formulas */
                          qed
                        next
                          case c_exp
                          by solve( !KU( ~x ) @ #vk.57 )
                        qed
                      qed
                    qed
                  qed
                qed
              qed
            next
              case P_HandleQuery
              solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                               <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                               >),
                                                       <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                        'g'^~x.1>,
                                                       '32'),
                                                <'HPKE_v1', 'secret', 'blank'>),
                                        <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                 <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                     ) @ #vk.27 )
                case c_Expand
                solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                          <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                  <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                   'g'^~x.1>,
                                                  '32'),
                                           <'HPKE_v1', 'secret', 'blank'>),
                                   <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                       ) @ #vk.56 )
                  case c_Expand
                  solve( !KU( 'g'^(~x*~x.1) ) @ #vk.52 )
                    case Generate_DH_key_pair
                    by solve( !KU( ~x ) @ #vk.66 )
                  next
                    case P_HandleQuery
                    solve( !KU( ~x.1 ) @ #vk.66 )
                      case RevDH
                      by contradiction /* from formulas */
                    qed
                  next
                    case c_exp
                    by solve( !KU( ~x ) @ #vk.68 )
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  next
    case c_senc
    solve( !KU( ~k ) @ #vk.2 )
      case RevSK
      solve( !KU( ~msg_id ) @ #vk.3 )
        case C_QueryGeneration
        solve( !KU( aead(Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_key', '32'),
                         Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_nonce', '32'),
                         <'0x02', key_id>, a)
               ) @ #vk.8 )
          case T_HandleQuery
          by contradiction /* from formulas */
        next
          case c_aead
          solve( !KU( Expand(Extract(<~query, key_id>,
                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'),
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                             'odoh_key', '32')
                 ) @ #vk.10 )
            case c_Expand
            solve( !KU( Expand(Extract(<~query, key_id>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~x.1)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 
                                                                     'g'^~x.1>,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                               'odoh_nonce', '32')
                   ) @ #vk.11 )
              case c_Expand
              solve( !KU( Extract(<~query, key_id>,
                                  Expand(Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~x.1)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~x.1>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                         <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                     ) @ #vk.13 )
                case c_Extract
                solve( !KU( ~query ) @ #vk.19 )
                  case C_QueryGeneration
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.26 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.53 )
                      case c_Expand
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.49 )
                        case C_QueryGeneration
                        solve( !KU( ~x.1 ) @ #vk.63 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.63 )
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.65 )
                      qed
                    qed
                  qed
                next
                  case NonceReuse
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.20 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.23 )
                      case c_Expand
                      solve( !KU( Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>)
                             ) @ #vk.31 )
                        case c_Extract
                        solve( !KU( Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                           '32')
                               ) @ #vk.38 )
                          case c_Expand
                          solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                                 ) @ #vk.44 )
                            case c_Extract
                            solve( !KU( 'g'^(~x*~x.1) ) @ #vk.53 )
                              case C_QueryGeneration
                              solve( !KU( ~x.1 ) @ #vk.54 )
                                case RevDH
                                by contradiction /* from formulas */
                              qed
                            next
                              case Generate_DH_key_pair
                              by solve( !KU( ~x ) @ #vk.54 )
                            next
                              case P_HandleQuery
                              solve( !KU( ~x.1 ) @ #vk.56 )
                                case RevDH
                                by contradiction /* from formulas */
                              qed
                            next
                              case c_exp
                              by solve( !KU( ~x ) @ #vk.56 )
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                next
                  case P_HandleQuery
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.26 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.55 )
                      case c_Expand
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.65 )
                      next
                        case P_HandleQuery
                        solve( !KU( ~x.1 ) @ #vk.65 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.67 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      next
        case P_HandleQuery
        solve( !KU( aead(Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_key', '32'),
                         Expand(Extract(<~query, key_id>,
                                        Expand(Expand(Extract(Expand(Extract('blank',
                                                                             <'HPKE_v1', 'eae_prk', 
                                                                              'g'^(~x*~x.1)>),
                                                                     <'32', 'HPKE_v1', 
                                                                      'shared_secret', 'g'^~x, 
                                                                      'g'^~x.1>,
                                                                     '32'),
                                                              <'HPKE_v1', 'secret', 'blank'>),
                                                      <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                      '32'),
                                               <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                                'odoh_nonce', '32'),
                         <'0x02', key_id>, a)
               ) @ #vk.8 )
          case T_HandleQuery
          by contradiction /* from formulas */
        next
          case c_aead
          solve( !KU( Expand(Extract(<~query, key_id>,
                                     Expand(Expand(Extract(Expand(Extract('blank',
                                                                          <'HPKE_v1', 'eae_prk', 
                                                                           'g'^(~x*~x.1)>),
                                                                  <'32', 'HPKE_v1', 
                                                                   'shared_secret', 'g'^~x, 'g'^~x.1
                                                                  >,
                                                                  '32'),
                                                           <'HPKE_v1', 'secret', 'blank'>),
                                                   <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                   '32'),
                                            <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                             'odoh_key', '32')
                 ) @ #vk.12 )
            case c_Expand
            solve( !KU( Expand(Extract(<~query, key_id>,
                                       Expand(Expand(Extract(Expand(Extract('blank',
                                                                            <'HPKE_v1', 'eae_prk', 
                                                                             'g'^(~x*~x.1)>),
                                                                    <'32', 'HPKE_v1', 
                                                                     'shared_secret', 'g'^~x, 
                                                                     'g'^~x.1>,
                                                                    '32'),
                                                             <'HPKE_v1', 'secret', 'blank'>),
                                                     <'32', 'HPKE_v1', 'exp', '0x01', info_hash>,
                                                     '32'),
                                              <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')),
                               'odoh_nonce', '32')
                   ) @ #vk.13 )
              case c_Expand
              solve( !KU( Extract(<~query, key_id>,
                                  Expand(Expand(Extract(Expand(Extract('blank',
                                                                       <'HPKE_v1', 'eae_prk', 
                                                                        'g'^(~x*~x.1)>),
                                                               <'32', 'HPKE_v1', 'shared_secret', 
                                                                'g'^~x, 'g'^~x.1>,
                                                               '32'),
                                                        <'HPKE_v1', 'secret', 'blank'>),
                                                <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                         <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32'))
                     ) @ #vk.15 )
                case c_Extract
                solve( !KU( ~query ) @ #vk.21 )
                  case C_QueryGeneration
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.28 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.55 )
                      case c_Expand
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.51 )
                        case C_QueryGeneration
                        solve( !KU( ~x.1 ) @ #vk.65 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.65 )
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.67 )
                      qed
                    qed
                  qed
                next
                  case NonceReuse
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.22 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.25 )
                      case c_Expand
                      solve( !KU( Extract(Expand(Extract('blank',
                                                         <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                                 <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1
                                                 >,
                                                 '32'),
                                          <'HPKE_v1', 'secret', 'blank'>)
                             ) @ #vk.33 )
                        case c_Extract
                        solve( !KU( Expand(Extract('blank',
                                                   <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>),
                                           <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 'g'^~x.1>,
                                           '32')
                               ) @ #vk.40 )
                          case c_Expand
                          solve( !KU( Extract('blank', <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)>)
                                 ) @ #vk.46 )
                            case c_Extract
                            solve( !KU( 'g'^(~x*~x.1) ) @ #vk.55 )
                              case C_QueryGeneration
                              solve( !KU( ~x.1 ) @ #vk.56 )
                                case RevDH
                                by contradiction /* from formulas */
                              qed
                            next
                              case Generate_DH_key_pair
                              by solve( !KU( ~x ) @ #vk.56 )
                            next
                              case P_HandleQuery
                              solve( !KU( ~x.1 ) @ #vk.58 )
                                case RevDH
                                by contradiction /* from formulas */
                              qed
                            next
                              case c_exp
                              by solve( !KU( ~x ) @ #vk.58 )
                            qed
                          qed
                        qed
                      qed
                    qed
                  qed
                next
                  case P_HandleQuery
                  solve( !KU( Expand(Expand(Extract(Expand(Extract('blank',
                                                                   <'HPKE_v1', 'eae_prk', 
                                                                    'g'^(~x*~x.1)>),
                                                           <'32', 'HPKE_v1', 'shared_secret', 
                                                            'g'^~x, 'g'^~x.1>,
                                                           '32'),
                                                    <'HPKE_v1', 'secret', 'blank'>),
                                            <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32'),
                                     <'32', 'HPKE_v1', 'sec', 'odoh_secret'>, '32')
                         ) @ #vk.28 )
                    case c_Expand
                    solve( !KU( Expand(Extract(Expand(Extract('blank',
                                                              <'HPKE_v1', 'eae_prk', 'g'^(~x*~x.1)
                                                              >),
                                                      <'32', 'HPKE_v1', 'shared_secret', 'g'^~x, 
                                                       'g'^~x.1>,
                                                      '32'),
                                               <'HPKE_v1', 'secret', 'blank'>),
                                       <'32', 'HPKE_v1', 'exp', '0x01', info_hash>, '32')
                           ) @ #vk.57 )
                      case c_Expand
                      solve( !KU( 'g'^(~x*~x.1) ) @ #vk.53 )
                        case Generate_DH_key_pair
                        by solve( !KU( ~x ) @ #vk.67 )
                      next
                        case P_HandleQuery
                        solve( !KU( ~x.1 ) @ #vk.67 )
                          case RevDH
                          by contradiction /* from formulas */
                        qed
                      next
                        case c_exp
                        by solve( !KU( ~x ) @ #vk.69 )
                      qed
                    qed
                  qed
                qed
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

/* All well-formedness checks were successful. */

end